<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Post-Apoc PokeWorld</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
</head>

<body>
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>

        <img id="rival-sprite" class="hidden" 
             src="daycare.png"
             alt="Rival">

        <div id="ui-layer">
            <div id="flash-overlay"></div>

            <div id="raid-hud" class="hidden">
                <div id="raid-timer">5:00</div>
                <div id="raid-base-hp-container">
                    <div id="raid-base-hp-fill"></div>
                </div>
                <div style="font-size: 8px; color: #fff; text-shadow: 1px 1px 0 #000; margin-top: 2px;">BASE HP</div>
            </div>

            <div id="dialog-box" class="hidden">
                <p id="dialog-text"></p>
                <div id="dialog-arrow">▼</div>
            </div>

            <div id="battle-ui" class="hidden">
                <!-- BOSS HUD (Hidden by default) -->
                <div id="boss-hud" class="hidden">
                    <div class="boss-name" id="boss-name">BOSS NAME</div>
                    <div class="boss-hp-container">
                        <div class="boss-hp-fill" id="boss-hp-fill"></div>
                        <div class="boss-hp-text" id="boss-hp-text">1000/1000</div>
                    </div>
                </div>

                <div id="enemy-stat-box" class="normal-enemy-ui">
                    <span id="enemy-name"></span> <span id="enemy-level"></span>
                    <div class="hp-bar-bg">
                        <div id="enemy-hp-fill" class="hp-bar-fill"></div>
                    </div>
                </div>
                <div id="player-stat-box">
                    <span id="player-name"></span> <span id="player-level"></span>
                    <div class="hp-bar-bg">
                        <div id="player-hp-fill" class="hp-bar-fill"></div>
                    </div>
                    <div id="player-hp-text" style="text-align: right; font-size: 10px;"></div>
                    <div class="exp-bar-bg">
                        <div id="player-exp-bar" class="exp-bar-fill"></div>
                    </div>
                </div>

                <!-- Sprites -->
                <img id="enemy-sprite" src="" alt="Enemy" />

                <!-- NEW SQUAD CONTAINER: Replaces old player-sprite -->
                <div id="player-party-container">
                    <!-- JavaScript will inject 6 Pokemon wrappers here -->
                </div>

                <div id="battle-menu">
                    <div id="battle-dialog">What will you do?</div>
                    <div class="battle-options">
                        <button onclick="battleSystem.attackBtn()">FIGHT</button>
                        <button onclick="battleSystem.bagBtn()">BAG</button>
                        <button onclick="battleSystem.pokemonBtn()">PKMN</button>
                        <button onclick="battleSystem.runBtn()">RUN</button>
                        <button id="btn-auto" onclick="battleSystem.toggleAuto()"
                            style="grid-column: span 2; background-color: #fff; color: #000;">AUTO</button>
                    </div>
                </div>
                <div id="move-selector" class="hidden">
                    <!-- Moves generated dynamically -->
                    <button onclick="battleSystem.useMove(0)" id="move-0">-</button>
                    <button onclick="battleSystem.useMove(1)" id="move-1">-</button>
                    <button onclick="battleSystem.useMove(2)" id="move-2">-</button>
                    <button onclick="battleSystem.useMove(3)" id="move-3">-</button>
                    <button onclick="battleSystem.closeMoves()">BACK</button>
                </div>

                <div id="bag-menu" class="hidden battle-sub-menu">
                    <div class="menu-header">BAG</div>
                    <div id="bag-list"></div>
                    <button onclick="battleSystem.closeMenus()" class="back-btn">BACK</button>
                </div>

                <div id="pokemon-menu" class="hidden battle-sub-menu">
                    <div class="menu-header">POKEMON</div>
                    <div id="pokemon-list"></div>
                    <div id="pokemon-list"></div>
                    <button onclick="battleSystem.closeMenus()" class="back-btn">BACK</button>
                </div>

                <div id="confirmation-dialog" class="hidden battle-sub-menu"
                    style="height: auto; top: 30%; bottom: 30%; border: 2px solid white;">
                    <div class="menu-header" id="confirm-text">Use Item?</div>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="battleSystem.confirmAction(true)" class="menu-item"
                            style="flex: 1;">YES</button>
                        <button onclick="battleSystem.confirmAction(false)" class="menu-item"
                            style="flex: 1;">NO</button>
                    </div>
                </div>

                <div id="new-catch-overlay" class="hidden battle-sub-menu">
                    <div class="menu-header">GOTCHA!</div>
                    <div id="catch-stats" style="text-align: center; margin-bottom: 20px;"></div>
                    <button onclick="battleSystem.closeCatchScreen()" class="back-btn">CONTINUE</button>
                </div>

                <!-- Comic Book Battle Effects -->
                <div id="attack-text"></div>
                <div id="damage-text"></div>
                <div id="effectiveness-text"></div>
            </div>

            <img id="pokeball-anim" class="hidden"
                src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png">

            <div id="quest-tracker">
                <small>QUEST</small><br>
                <span id="quest-desc">Travel 200 steps</span>
            </div>

            <!-- Party Sidebar moved to end of game-container -->

            <div id="bottom-hud">
                <div id="hud-money">$0</div>
                <div id="hud-xp-bar-container">
                    <div id="hud-xp-text">XP: 0 / 100</div>
                    <div id="hud-xp-fill"></div>
                </div>
            </div>

            <div id="npc-prompt" class="hidden">Press A to talk</div>

            <!-- Player Bag Menu (B Button) -->
            <div id="player-bag-menu" class="hidden battle-sub-menu">
                <div class="menu-header">BAG</div>
                <div class="bag-tabs">
                    <button id="tab-pokemon" class="tab-btn active"
                        onpointerdown="showBagTab('pokemon')">POKEMON</button>
                    <button id="tab-items" class="tab-btn" onpointerdown="showBagTab('items')">ITEMS</button>
                </div>
                <div id="bag-content"></div>
                <!-- FIXED: added onpointerdown for mobile touch -->
                <button onpointerdown="closePlayerBag()" class="back-btn">CLOSE</button>
            </div>

            <div id="level-up-overlay" class="hidden">
                <div class="levelup-header">LEVEL UP!</div>
                <div id="levelup-content"></div>
                <div id="move-learn-container" class="hidden">
                    <p>Wants to learn <span id="new-move-name" style="color:yellow;"></span>!</p>
                    <div id="move-forget-list"></div>
                    <button onclick="battleSystem.skipLearnMove()" class="menu-item" style="background:#e74c3c;">Do not
                        learn</button>
                </div>
                <button id="levelup-continue-btn" onclick="battleSystem.closeLevelUp()"
                    ontouchstart="battleSystem.closeLevelUp()" class="back-btn">CONTINUE</button>
            </div>

            <div id="stats-overlay">
                LVL: <span id="meta-level">1</span> | Time: <span id="meta-time">0h</span>
            </div>


            <!-- Main Menu Modal -->
            <div id="main-menu-modal" class="hidden full-screen-modal">
                <div class="modal-content">
                    <h2>PAUSED</h2>

                    <div id="game-version"
                        style="color: #888; font-size: 10px; margin-bottom: 15px; font-family: monospace;">Loading...
                    </div>

                    <div class="menu-grid">
                        <button onclick="toggleMainMenu()" ontouchstart="toggleMainMenu()">RESUME</button>
                        <button onclick="openPokedex()" ontouchstart="openPokedex()">POKEDEX</button>
                        <button onclick="openPC()" ontouchstart="openPC()">PC STORAGE</button>
                        <button onclick="goHome()" ontouchstart="goHome()">GO HOME</button>
                        <button onclick="togglePlayerBag(); toggleMainMenu()"
                            ontouchstart="togglePlayerBag(); toggleMainMenu()">BAG</button>
                        <button onclick="openOptions()" ontouchstart="openOptions()">OPTIONS</button>
                        <button onclick="saveGame(); showDialog('Game Saved!', 2000)"
                            ontouchstart="saveGame(); showDialog('Game Saved!', 2000)">SAVE GAME</button>
                        <button onclick="loadGame(); showDialog('Game Loaded!', 2000); toggleMainMenu()"
                            ontouchstart="loadGame(); showDialog('Game Loaded!', 2000); toggleMainMenu()">LOAD
                            GAME</button>
                    </div>
                </div>
            </div>

            <!-- Options Modal -->
            <div id="options-modal" class="hidden full-screen-modal">
                <div class="modal-content">
                    <h2>OPTIONS</h2>
                    <div class="option-row">
                        <label>Volume</label>
                        <input type="range" min="0" max="100" value="50" oninput="setVolume(this.value)">
                    </div>
                    <div class="option-row">
                        <label>Game Speed</label>
                        <div class="speed-toggles">
                            <button onclick="setGameSpeed(1)" id="speed-1" class="active"
                                ontouchstart="setGameSpeed(1)">x1</button>
                            <button onclick="setGameSpeed(2)" id="speed-2" ontouchstart="setGameSpeed(2)">x2</button>
                        </div>
                    </div>
                    <button onclick="closeOptions()" class="back-btn" ontouchstart="closeOptions()">BACK</button>
                </div>
            </div>

            <!-- Pokedex Modal -->
            <div id="pokedex-modal" class="hidden full-screen-modal">
                <div class="modal-header">
                    <h2>POKEDEX</h2>
                    <span id="pokedex-count">Seen: 0/151</span>
                </div>
                <div class="pokedex-tabs"
                    style="display: flex; gap: 10px; margin-bottom: 10px; justify-content: center;">
                    <button id="pokedex-tab-normal" class="tab-btn active" onpointerdown="showPokedexTab('normal')"
                        style="flex: 1; max-width: 200px;">NORMAL</button>
                    <button id="pokedex-tab-shiny" class="tab-btn" onpointerdown="showPokedexTab('shiny')"
                        style="flex: 1; max-width: 200px;">SHINY ✨</button>
                </div>
                <div id="pokedex-grid"></div>
                <button onclick="closePokedex()" class="back-btn" ontouchstart="closePokedex()">CLOSE</button>
            </div>

            <!-- PC Modal -->
            <div id="pc-modal" class="hidden full-screen-modal">
                <div class="pc-layout">
                    <div class="pc-party">
                        <h3>PARTY</h3>
                        <div id="pc-party-list"></div>

                        <div id="merge-ui-container">
                            <div class="merge-header">MERGE LAB ($5000)</div>
                            <div id="merge-slots">
                                <div class="merge-slot" onclick="mergeSystem.removeFromSlot(0); renderPC();" id="ms-0">1
                                </div>
                                <div class="merge-slot" onclick="mergeSystem.removeFromSlot(1); renderPC();" id="ms-1">2
                                </div>
                                <div class="merge-slot" onclick="mergeSystem.removeFromSlot(2); renderPC();" id="ms-2">3
                                </div>
                            </div>
                            <button id="btn-perform-merge" onclick="mergeSystem.performMerge()">MERGE!</button>
                        </div>
                    </div>
                    <div class="pc-box">
                        <div class="box-header">
                            <button onclick="prevBox()" ontouchstart="prevBox()">◀</button>
                            <span id="box-label">BOX 1</span>
                            <button onclick="nextBox()" ontouchstart="nextBox()">▶</button>
                        </div>
                        <div id="pc-box-grid"></div>
                    </div>
                </div>

                <!-- PC Action Buttons -->
                <div id="pc-actions" class="hidden" style="margin-top: 10px;">
                    <button id="pc-add-to-party" class="back-btn" style="background: #2ecc71; margin: 5px;"
                        onclick="addToParty()">ADD TO PARTY</button>
                    <button id="pc-move-to-pc" class="back-btn" style="background: #3498db; margin: 5px;"
                        onclick="moveToPC()">MOVE TO PC</button>
                    <button class="back-btn" style="background: #e74c3c; margin: 5px;"
                        onclick="cancelPCSelection()">CANCEL</button>
                </div>

                <button onclick="closePC()" class="back-btn" ontouchstart="closePC()">CLOSE</button>
            </div>

            <!-- Pokemon List Modal (shows all owned Pokemon of a species) -->
            <div id="pokemon-list-modal" class="hidden full-screen-modal">
                <div class="modal-content">
                    <h2 id="pokemon-list-title">POKEMON</h2>
                    <div id="pokemon-list-content" style="max-height: 70vh; overflow-y: auto;"></div>
                    <button onpointerdown="closePokemonList()" class="back-btn">CLOSE</button>
                </div>
            </div>

            <!-- Pokemon Stats Detail Modal -->
            <div id="pokemon-stats-modal" class="hidden full-screen-modal">
                <div class="modal-content" style="max-width: 500px;">
                    <div id="pokemon-stats-display"></div>
                    <button onpointerdown="closePokemonStats()" class="back-btn">CLOSE</button>
                </div>
            </div>
        </div>

        <div id="mobile-controls">
            <!-- D-Pad Removed for Invisible Joystick -->
            <div id="joystick-zone" style="position: absolute; top: 0; left: 0; width: 50%; height: 100%; z-index: 10;">
            </div>
            <div id="action-btns">
                <div class="action-btn b-btn" onclick="togglePlayerBag()" ontouchstart="togglePlayerBag()">B</div>
                <div class="action-btn a-btn" onpointerdown="input.press('Enter')" onpointerup="input.release('Enter')"
                    onpointerleave="input.release('Enter')">A
                </div>
            </div>
        </div>

        <!-- Party Sidebar (Moved here to be on top of joystick) -->
        <div id="party-sidebar"></div>

        <!-- Hamburger Button (Moved to top level for touch access) -->
        <div id="hamburger-btn" onclick="toggleMainMenu()" ontouchstart="event.preventDefault(); toggleMainMenu()">☰
        </div>

        <!-- Audio -->
        <audio id="main-music" src="music.mp3" loop preload="auto"></audio>
        <audio id="battle-music" src="battle.mp3" loop preload="auto"></audio>

        <!-- Sound Effects -->
        <audio id="sfx-pickup" src="pickup.mp3" preload="auto"></audio>
        <audio id="sfx-attack1" src="attack1.mp3" preload="auto"></audio>
        <audio id="sfx-attack2" src="attack2.mp3" preload="auto"></audio>
        <audio id="sfx-attack3" src="attack3.mp3" preload="auto"></audio>
    </div>

    <div id="store-ui" class="hidden">
        <div class="store-header">
            <span>POKE MART</span>
            <!-- Change to onpointerdown -->
            <button onpointerdown="storeSystem.closeUI()" class="close-btn">X</button>
        </div>
        <div class="store-tabs">
            <button id="store-buy-tab" onpointerdown="storeSystem.showBuyTab()" class="active">BUY</button>
            <button id="store-sell-tab" onpointerdown="storeSystem.showSellTab()">SELL</button>
        </div>
        <div id="store-money" class="store-money">Money: $0</div>
        <div id="store-list" class="store-list">
            <!-- Dynamic Items -->
        </div>
    </div>

    <!-- Scripts Load Order is Vital -->
    <script src="src/utils.js"></script>
    <script src="src/data.js"></script>
    <script src="src/rpg_core.js"></script>
    <script src="src/enemies.js"></script>
    <script src="src/resources.js"></script>
    <script src="src/guardian.js"></script>
    <script src="src/liminal.js"></script>
    <script src="src/world.js"></script>
    <script src="src/anime-bg.js"></script>
    <script src="src/battle.js"></script>
    <script src="src/combine.js"></script>
    <script src="src/arena.js"></script>
    <script src="src/rival.js"></script>
    <script src="src/home.js"></script>
    <script src="src/store.js"></script>
    <script src="src/defense.js"></script>
    <script src="src/loading.js"></script>
    <script src="src/main.js"></script>
</body>

</html>
